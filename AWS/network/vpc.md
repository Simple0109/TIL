# VPC
`Virtual Private Cloud`の略で、クラウド上に仮想的なネットワークを構築するためのサービス   
多くのAWSサービスはネットワークを構築しなくても個別に通信することができるが、この方法では成り行きで通信経路が決まってしまうため 
セキュリティや性能面での制御が難しくなる  
VPC内では、サブネット、ルートテーブル、インターネットゲートウェイ、NATゲートウェイ、セキュリティグループ、ネットワークACLなどのコンポーネントを組み合わせて使用する。これにより、インスタンスの配置、通信経路の設定、セキュリティルールの適用などが柔軟に行える。
VPCを使うことで隔離されたプライベートネットワーク構成をユーザーがコントロールすることができる   
VPCは**リージョンを選択して、複数のAZをまたがって作成できる**。これにより**可用性が向上**する   
VPCを使うことで以下のようなメリットがある 
* 通信経路を絞って、監視・アクセス制御を行うことで**セキュリティを向上**させる
* 通信経路を明示的に制御してロードバランサー等でスケールアウトすることで**性能を担保**できる
* 通信経路に明示的に複数確保することで**可用性を向上**させる
* システム内のサービスを整理して一括管理することで**運用・保守性を向上**させることができる
* IaCサービスと組み合わせることで**移行性が向上**する
※`IaC`:`Infrastracture as Code`の略。AWSなどのクラウド環境の構築を従来の手動プロセスではなく、インフラ構成や設定に関する情報を定義ファイルやコードとして記述し、ツール・OSSによって自動的に適用する手法  

## VPCの役割
システム・アプリ開発においてネットワーク設計は以下の**非機能要件**を満たす上で大切な役割を持つ  

1. 可用性：必要なときにいつでもサービスが提供されており、停止しない
2. 性能・拡張性：必要な速度が確保されている。また利用者が増えても対応できる
3. 運用・保守性：運用監視や問題発生時の対応を適切に行える
4. 移行性：新環境への移行の容易性
5. セキュリティ：不正アクセスを防止する
6. システム環境・エコロジー：システムの設置環境や自然環境に与える影響

オンプレ環境で、上記のような非機能要件を満たすのは高度なネットワーク知識や、機器を揃えるためのコストが必要となる  
AWSでは可用性やセキュリティ向上のための機能がデフォルトである程度組み込まれており、それに加えて、さらに**非機能要件を向上させるためのサービス**が多数準備されているので   
これらを組み合わせることで高度な非機能要件を満たすことができる  
**VPC**はこれらのサービス同士を**ネットワークで繋ぐ基盤**となる

|サービス名|該当する非機能要件|概要|
|:--:|:--:|:--|
|ELB|可用性、性能・拡張性|ロードバランサによる過負荷防止|
|Cloud Front|可用性、性能・拡張性|CDNによるアクセス速度向上と過負荷防止|
|Route 53|可能性、性能・拡張性・セキュリティ|DNSルーティング、DNSヘルスチェックによる可用性向上、DNSファイアウォールによるセキュリティの向上|
|Network Firewall|セキュリティ|サブネットに対するアクセスルールを設定する|
|WAF|セキュリティ|Webアプリに対する一般的な攻撃パターンをブロック|
|Direct Connect|セキュリティ|専用線接続によるセキュリティ向上|
これらのサービスは**VPCと連動した動作が前提となっている   

## インターネットゲートウェイ
1つのVPCにつき1つ作成することができ**VPCから外部のインターネットへの出入り口となる**  
インターネットゲートウェイ自体が高い冗長性と可用性を持っているため**単一障害点(SPOF:Single Point Failure)**にはならない   
インターネットゲートウェイは作成してVPCにアタッチすることで使用できる   

## パブリックサブネットとプライベートサブネット
セキュリティの観点から、インターネットと直接通信できるホストは必要最小限に絞ることが望ましい  
これを実現するために**パブリックサブネット**と**プライベートサブネット**を分ける方法が一般的  
* パブリックサブネット
インターネットと直接**通信できるサブネット**  
VPCからインターネットに接続するにはインターネットゲートウェイへの接続が必要なため、パブリックサブネットが**インターネットゲートウェイが接続されるサブネット**となる   
* プライベートサブネット
インターネットと直接**通信できないサブネット**  
インターネットとの通信が必要ないインスタンスをプライベートサブネットに設置することで、外部からのアクセスを最小限にすることができ**システム全体のセキュリティを高める**ことができる

## ルートテーブル
**ルートテーブル**とVPCのサブネットを関連付け、通信を振り分けるルールを作成することができる   
1つのサブネットに対して、**1つのルートテーブルしか関連づけられない**
サブネットAとルートテーブルAを関連付けた場合、ルートテーブルAに作成したルールに基づいてルーティングが行われる   
サブネットBとルートテーブルBを関連付けた場合、同じ  
VPCを作成した段階で**メインルートテーブル**というルートテーブルができるが、そのまま使い続けるのではなく、別途カスタムルートテーブルを作成してサブネットに関連づけたほうがよい

### セキュリティグループ
EC2インスタンスやDBインスタンスなどのインスタンスに対する通信トラフィックを制御するファイアウォール 
HTTPやSSHなどのプロトコルを指定して通信を許可する設定を行うことができる 
セキュリティグループはサブネットレベルではなく、インスタンスレベルで動作するため、VPC内のインスタンスごとに異なるセキュリティグループを割り当てることができる   
デフォルトではインバウンドルール（受信）ルールがないため**暗黙的に全てを拒否する設定**になっている  
許可するトラフィックを適宜追加していくことになる

### ネットワークACL
VPCサブネットのインバウンドトラフィックとアウトバウンドトラフィックを制御できる   
サブネットに設定することでEC2インスタンスが配置されているサブネット全体のトラフィック制御ができる   
しかしこれはEC2インスタンス単体ではなく、サブネット全体のトラフィック制御となる   
ネットワークACLはデフォルトで全てのトラフィックを許可しているため、必要な要件があった場合（特定のトラフィックを拒否したい）場合に、追加のセキュリティレイヤーとして使用する。特に必要な要件がない場合は、デフォルトの許可で運用する   

### VPCフローログ
VPC内部のEC2インスタンスや、ELBに紐づけられたネットワークインターフェースに出入りする**IPトラフィックを記録する**機能 
トラブルシューティングや外部からの侵入などのインシデント調査に使用される  
VPCフローログは**S3, CloudWatch, Kinesis Data Firebase**のいずれかに出力できる。それぞれの使い分けは以下の通り
* S3:フローログを蓄積して**Athena**で分析する場合
* CloudWatch:ネットワークトラフィックの特定のアクセス傾向を検知してアラームを発する場合
* Kinesis Data Firehose:フローログをリアルタイムにストリーミングして保存、処理したい場合
※`Athena`:S3バケットに保存されているJSON、CSV、などのテキストデータに対してSQLクエリを実行できる分析サービス  

### VPN接続
`Virtual Private Network`の略   
*VPCとオンプレネットワーク間に仮想的なプライベートネットワークを作成**するサービス  
AWS側に**仮想プライベートゲートウェイ**を作成し、オンプレミス側のカスタマーゲートウェイを指定することでVPN接続することができる

### AWS Direct Connect
帯域を確保するため、もしくはセキュリティとコンプライアンス要件みたすために**専用線**を選択する場合に使用する  
AWS間とデータセンター間でプライベートなネットワーク接続を確立できるため、ハイブリッド環境を構築する上で重要なサービスになる

#　参考記事
[【図解AWS】ルートテーブルとは？初心者にもわかりやすく解説！](https://en-junior.com/routetable/)